<div align="center">

<p>
<h1>Project AIR</h1>
</p>

<p>
 <a href="https://www.rijkswaterstaat.nl"><img src="https://img.shields.io/badge/RWS-Approved-yellow.svg?longCache=true&style=flat-square&logo=gov.uk&logoColor=white&link=https://www.rijkswaterstaat.nl&colorA=000000&colorB=154273" alt="RWS Approved" /></a><!--
--><a href="https://www.slack.com"><img src="https://img.shields.io/badge/Slack-Powered-green.svg?longCache=true&style=flat-square&logo=slack&logoColor=white&link=https://www.slack.com&colorA=000000&colorB=56B68B" alt="Slack Powered"></a><!--
--><a href="https://trello.com/b/3kB54O2t/air-retro-board"><img src="https://img.shields.io/badge/Trello-Managed-blue.svg?longCache=true&style=flat-square&logo=trello&logoColor=white&link=https://www.slack.com&colorA=000000&colorB=0079BF" alt="Trello Managed"></a><!--
--><a href="https://www.pivotaltracker.com/n/projects/1915901"><img src="https://img.shields.io/badge/Pivotal-Tracked-blue.svg?longCache=true&style=flat-square&link=https://www.pivotaltracker.com/n/projects/1915901&colorA=000000&colorB=ED7D00&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAAAXNSR0IArs4c6QAAAn5JREFUKBVNUk1IVFEUPue+lzKpNYQQtGqcbCdCuspSkzYtckjSIEEao9q4CVRcjKlo+V/kooXBTFNCNpqhi2hjVuIiyjJrYzSRBVGg9INazrx7T98bGejCu5x7z3fO+b7vXab/VnV7LFucPxeNMceJyZ9KCcWJeSrLq67daapbT8M5HVS33i7TRkeEZDcLzwnTvGJiESki4RKcv1qKguOdwVm3JlV4MhQp14YeE8kzW9nBAaf/pxFqJbaGfD0Ln06FbvkTRiLMUqIUl7vF7NLTyfVFIVqe6DpTwch+bC4YIZFaUBzP63tbvdxScPR5vHXmbv76DEbtyfZahVwViraJ6OZC+VxSl7yf79LYZiknafQoCWVYll2jtRNDk5fd1oXaVc5aQHxFEekApMyedR5kgGrM/RxtwszqBgDT0N2c0sQyd7O74T1Uz4FNpS0C91geJkl+ocEjFwQjNHsyez2bjv6rnQWcP5DHbndzkDIPWedg3JZBeX2LS8qi0wDlobTAJjuxyQqNZR6QJdnQI19aDuyDaagjslEYx4gi9yCaOrDvR/giubEWUySvEJeB2g43byjZxiTFwMdtYZ7ETeP50JBfEsOlvNVxEJNGDdEhZYOFUdBPFJWAg3EHLaV6lDdn1yA0rqxIzvDe7bnFpKxjvv5396BlCthM0Vzp610cjXrexF5bvuto/M2zk6+mHkDVpegRccw0M80QZdRPXK5ddvU4kmhQzB2NdpPXER0GzVJL2RVjnXVPU4UujROhcAW6hcE/F3bNCrumwBbhYrA/DMe/w8n68a7gk9S9u6VXfe9kzo/fq43oFsCdH79K4H8cTCYtO2tgrL1mLY39BzRkHFrrWeoEAAAAAElFTkSuQmCC" alt="Pivotal Tracked"></a><!--
--><a href="https://www.sketchapp.com"><img src="https://img.shields.io/badge/Sketch-Designed-blue.svg?longCache=true&style=flat-square&link=https://www.sketchapp.com&colorA=000000&colorB=F17100&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAAAXNSR0IArs4c6QAAAV1JREFUKBWlUb8vQ0Ec/1z7qtWmNYlgKTF0aQ0YaxcRu1HCLGL20tEm/gJ/ApGwGawYaGISmg4SbC3tq9e+8/3ceQbvdfK93L3PfX5873JPIab0dWYWQWbeSAnvTi15T39tKiT0KZYx5VwgrUahZKTWrOSfAVpGT3fx0l9R67iikOCib5BFgHM4KqsZUlVgYtNOwYYTjR7jDYNoSheNHNuooAxM77KfLcGG4xH00Cul9An2pVPNuGbmgOKhgZGlsQM8P1o6Adfxmih9vdt9pveBZHM7kiEx6ATwHqw0Mo6SeZxWDfcSLguBvNw0rtp1gAeIp15wUeHNkV/FQmoMbxT67WiMHDV66KXDBNUi/EIRlWQO3U7kjwHkqNFD72+QQG3hVa5RDdoY+C0ytojJUaMn5M2J4Sa3h9v0JDa8hjz8TxGToxZyQ7+fB3D9YwScxEONcYJ3hMuuzDjtX9w3aVN9Whe7I0sAAAAASUVORK5CYII=" alt="Sketch Designed" /></a><!--
--><a href="https://app.zeplin.io/project/587661de593c722607342d7b"><img src="https://img.shields.io/badge/Zeplin-Based-blue.svg?longCache=true&style=flat-square&link=https://app.zeplin.io/project/587661de593c722607342d7b&colorA=000000&colorB=FEBD12&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAAOCAYAAAAi2ky3AAAAAXNSR0IArs4c6QAAAjBJREFUKBWtUU1rE1EUPfe9yUyajza2TRsq2EVswQqK6N6FiOJGBbeuq+hfKLhw48qFVBRd6A8QxEVFEFy3qLhQUREqBa1JbU0ymXzMzLvXN60fsRay8cJ9vDfvnDPnnQv0qcal/HRtNnu8Dwy0E8C/kBsT0JTtSJPpZMeHPobpetk9mXKgKEZKfNpX+9TLdXoPv/a50pGNZvX5Rv4EODI0h3Iw40IfBLNCrIBQQ16OvINnrtH+2r2Et6MjWS4UzGu+pffgDFfJU3kPiFwgTgHSQyEBVGuOjlau/uNI3hYmUecFtUvNyNcBoG3JejuMmdvcMBVJR6t01hr6W0iWiiV0whfoZEYoysD4EUgnxm0pEQnZN1WjOHCyAlWQjoFUgifJ9eavwrt7D4Hj89wIZpU3mEFkXdjSwykxK61uHKFrvtOgTcL2ljtuxYiXGw2tzI0E68j96d3dbvQYgnHHswJWRIiF69yJ1+ByTaUpI2lybMhJGUFcaSXtW865wdut1eTzZnLhnfJh1uZBasyMx1W4EumfLJttO4Z9FIjswNbbMLat2Iqj6XTuZvAqEUnq9wjkWflp/Ll7LFy2uXg2GEvmiAE/BFsx7horhi9a6LrjqEfpef/DlsTW2jMO8ZwJt6WH9UJ7qVE1lbDILClFUPat7zWpBWiUssXRh8G3talekWT/R0hwBTSwqE69aW4HNS9mD7CiTt4dWvQr65PIqM1ctuP6noPLoxOJWF/g/wD8AHyJ+Mm/jBDkAAAAAElFTkSuQmCC" alt="Zeplin Based" /></a>
</p>

</div>

---

## Installation

Install with [yarn](https://yarnpkg.com) or [npm](https://www.npmjs.com/):
```sh
yarn add @rws-air/jestscreenshot
npm install @rws-air/jestscreenshot
```

## Usage

### NodeJS
```js
const JestScreenshot = require('@rws-air/jestscreenshot');
```

When using ES6 modules:
```ts
import JestScreenshot from '@rws-air/jestscreenshot'
```

## About automated Slack uploading

This library supports uploading your screenshots to Slack by providing the `slackToken` option (or through an environment variable called `SLACK_WEBTOKEN`), as well providing Slack Channel IDs through the option `slackChannels` and setting `slackUpload` option to `true`. However uploading to Slack comes with one major caveat: time. It takes time to upload to Slack, longer than Jest wants each test to run. Jest defaults to 5000 milliseconds which is just too short. The recommended amount to set the timeout to is 30000 milliseconds (30 seconds). You can achieve this throughout your entire test set by creating a jest setup file and loading it pre-test by defining it in your jest config. See [the slack example](#slack_example) for an implementation

## Example

```ts
import JestScreenshot from '@rws-air/jestscreenshot'
import path from 'path';
import puppeteer from 'puppeteer';

beforeAll(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.setViewport({ width: 1280, height: 1024 });
  await page.goto('https://www.google.com', { waitUntil: 'networkidle0' });

  const jestScreenshotOptions: JestScreenshotOptions = {
      page,
      dirName: path.resolve(__dirname),
  };

  const jestScreenshot = new JestScreenshot(jestScreenshotOptions);

  await jestScreenshot.run();
});

afterAll(() => browser.close());

test('Confirm google hasn\'t gone whack', async () => {
  const title = await page.title();
  expect(title).toBe('Google');
});

test('And a forced failing test', () => {
  const title = await page.title();
  expect(title).toBe('Google has gone whack!');
  fail('should fail');
});
```

## Slack Example

```js
// jest.config.js

module.exports = {
  testMatch: ['<rootDir>/__tests__/index.test.ts'],
  globalSetup: '<rootDir>/__tests__/jest.setup.ts'
};
```

```ts
// __tests__/jest.setup.ts

const config = async () => {
  const setup = async (): Promise<void> => {
    jest.setTimeout(30000);

    return undefined;
  };

  setup();
};

export default config;
```

```ts
// __tests__/index.test.ts

import JestScreenshot from '@rws-air/jestscreenshot'
import path from 'path';
import puppeteer from 'puppeteer';

beforeAll(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.setViewport({ width: 1280, height: 1024 });
  await page.goto('https://www.google.com', { waitUntil: 'networkidle0' });

  const jestScreenshotOptions: JestScreenshotOptions = {
      page,
      dirName: path.resolve(__dirname),
  };

  const jestScreenshot = new JestScreenshot(jestScreenshotOptions);

  await jestScreenshot.run();
});

afterAll(() => browser.close());

test('Confirm google hasn\'t gone whack', async () => {
  const title = await page.title();
  expect(title).toBe('Google');
});

test('And a forced failing test', () => {
  const title = await page.title();
  expect(title).toBe('Google has gone whack!');
  fail('should fail');
});
```

## Documentation

### JestScreenshot
The main class of JestScreenshot that should be initialized with config


| Param | Type | Default | Description |
| --- | --- | --- | --- |
| page | <code>Page</code> |  | The Puppeteer page to take a screenshot from |
| dirName | <code>string</code> |  | The directory to create a "screenshots" folder in |
| [scriptName] | <code>string</code> | <code>&quot;jest-test&quot;</code> | An optional name of the script that is currently being ran |
| [slackUpload] | <code>boolean</code> | <code>false</code> | Optionally upload screenshots to slack after making them. Requires you pass a token to the slackToken option, or set the SLACK_WEBTOKEN environment variable |
| [slackToken=] | <code>string</code> |  | Token to use when uploading to slack. Required when you pass slackUpload=true Optionally you can also pass this through the environment variable "SLACK_WEBTOKEN". This option takes priority over the environment variable |
| [slackChannels] | <code>Array&lt;string&gt;</code> | <code>[]</code> | Channels to send the Slack upload to Should be an array of Slack channel IDs Only used when slackUpload is set to true |

#### run
Runs the JestScreenshot reporter

**Kind**: instance method of <code>JestScreenshot</code>  
**Returns**: <code>Promise&lt;void&gt;</code> - JestScreenshot reporter will have been initialiazed as a side effect for this test suite  
**Example**  
```ts
const jestScreenshotOptions: JestScreenshotOptions = {
  page,
  dirName: path.resolve(__dirname),
  slackUpload: true,
  slackChannels: ['ABCD'],
  slackToken: 'YOUR_TOKEN'
};

const jestScreenshot = new JestScreenshot(jestScreenshotOptions);

await jestScreenshot.run();
```
#### takeScreenshot
Takes a screenshot of the current page

**Kind**: instance method of <code>JestScreenshot</code>  
**Returns**: <code>Promise&lt;(SlackResponse\|Buffer)&gt;</code> - Either returns the response from Slack or the screenshot as a Buffer  
**Access**: protected  
#### uploadToSlack
Uploads screenshots to Slack using the provided token

**Kind**: instance method of <code>JestScreenshot</code>  
**Access**: protected  

| Param | Type | Description |
| --- | --- | --- |
| screenshot | <code>Buffer</code> | base64 representation of the screenshot to upload |

#### objectHasProperty
Validates if an object has a given property

**Kind**: instance method of <code>JestScreenshot</code>  
**Access**: protected  

| Param | Type | Description |
| --- | --- | --- |
| obj | <code>object</code> | The object to validate |
| prop | <code>string</code> | The property to try to find |

